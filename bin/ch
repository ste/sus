#!/usr/bin/env python3
"""Companies House API wrapper."""

import json
import os
import sys
import time
import urllib.error
import urllib.parse
import urllib.request
from base64 import b64encode
from pathlib import Path

BASE_URL = "https://api.company-information.service.gov.uk"
PROJECT_ROOT = Path(__file__).resolve().parent.parent
MAX_RETRIES = 3
RETRY_DELAY = 2


def load_key():
    env_file = PROJECT_ROOT / ".env"
    if not env_file.exists():
        print(f"Error: No .env file found at {env_file}", file=sys.stderr)
        print("Create one with: COMPANIES_HOUSE_API_KEY=your_key_here", file=sys.stderr)
        sys.exit(1)
    for line in env_file.read_text().splitlines():
        line = line.strip()
        if line.startswith("COMPANIES_HOUSE_API_KEY="):
            return line.split("=", 1)[1].strip().strip("\"'")
    print("Error: COMPANIES_HOUSE_API_KEY not found in .env", file=sys.stderr)
    sys.exit(1)


def api_get(api_key, path, params=None):
    url = BASE_URL + path
    if params:
        url += "?" + urllib.parse.urlencode(params)

    auth = b64encode(f"{api_key}:".encode()).decode()
    req = urllib.request.Request(url, headers={
        "Authorization": f"Basic {auth}",
        "Accept": "application/json",
    })

    for attempt in range(MAX_RETRIES):
        try:
            with urllib.request.urlopen(req) as resp:
                return json.loads(resp.read())
        except urllib.error.HTTPError as e:
            if e.code == 429:
                if attempt < MAX_RETRIES - 1:
                    time.sleep(RETRY_DELAY)
                    continue
                print(json.dumps({"error": "rate_limited", "message": "Too many requests â€” retries exhausted"}), file=sys.stderr)
                sys.exit(1)
            elif e.code == 404:
                print(json.dumps({"error": "not_found", "path": path}), file=sys.stderr)
                sys.exit(1)
            else:
                body = e.read().decode(errors="replace")
                print(json.dumps({"error": "api_error", "status": e.code, "body": body}), file=sys.stderr)
                sys.exit(1)


def api_get_all(api_key, path, extra_params=None):
    start = 0
    page_size = 100
    all_items = []

    while True:
        params = {"items_per_page": page_size, "start_index": start}
        if extra_params:
            params.update(extra_params)

        result = api_get(api_key, path, params)
        items = result.get("items", [])
        if not items:
            break

        all_items.extend(items)
        total = result.get("total_results") or result.get("total_count") or 0
        start += len(items)
        if start >= total:
            break

    return all_items


def output(data):
    print(json.dumps(data, indent=2, ensure_ascii=False))


# --- Commands ---

def cmd_search(api_key, args):
    if not args:
        print("Usage: ch search <query>", file=sys.stderr); sys.exit(1)
    output(api_get(api_key, "/search/companies", {"q": " ".join(args), "items_per_page": 20}))


def cmd_profile(api_key, args):
    if not args:
        print("Usage: ch profile <company_number>", file=sys.stderr); sys.exit(1)
    output(api_get(api_key, f"/company/{args[0]}"))


def cmd_officers(api_key, args):
    if not args:
        print("Usage: ch officers <company_number> [current]", file=sys.stderr); sys.exit(1)
    extra = {}
    if len(args) > 1 and args[1] == "current":
        extra = {"register_type": "directors", "register_view": "true"}
    output(api_get_all(api_key, f"/company/{args[0]}/officers", extra or None))


def cmd_pscs(api_key, args):
    if not args:
        print("Usage: ch pscs <company_number>", file=sys.stderr); sys.exit(1)
    output(api_get_all(api_key, f"/company/{args[0]}/persons-with-significant-control"))


def cmd_filings(api_key, args):
    if not args:
        print("Usage: ch filings <company_number> [category]", file=sys.stderr); sys.exit(1)
    params = {"items_per_page": 50}
    if len(args) > 1:
        params["category"] = args[1]
    output(api_get(api_key, f"/company/{args[0]}/filing-history", params))


def cmd_charges(api_key, args):
    if not args:
        print("Usage: ch charges <company_number>", file=sys.stderr); sys.exit(1)
    output(api_get_all(api_key, f"/company/{args[0]}/charges"))


def cmd_insolvency(api_key, args):
    if not args:
        print("Usage: ch insolvency <company_number>", file=sys.stderr); sys.exit(1)
    output(api_get(api_key, f"/company/{args[0]}/insolvency"))


def cmd_appointments(api_key, args):
    if not args:
        print("Usage: ch appointments <officer_id>", file=sys.stderr); sys.exit(1)
    output(api_get_all(api_key, f"/officers/{args[0]}/appointments"))


def cmd_search_officers(api_key, args):
    if not args:
        print("Usage: ch search-officers <name>", file=sys.stderr); sys.exit(1)
    output(api_get(api_key, "/search/officers", {"q": " ".join(args), "items_per_page": 20}))


def cmd_search_disqualified(api_key, args):
    if not args:
        print("Usage: ch search-disqualified <name>", file=sys.stderr); sys.exit(1)
    output(api_get(api_key, "/search/disqualified-officers", {"q": " ".join(args), "items_per_page": 20}))


def cmd_registered_office(api_key, args):
    if not args:
        print("Usage: ch registered-office <company_number>", file=sys.stderr); sys.exit(1)
    output(api_get(api_key, f"/company/{args[0]}/registered-office-address"))


COMMANDS = {
    "search": cmd_search,
    "profile": cmd_profile,
    "officers": cmd_officers,
    "pscs": cmd_pscs,
    "filings": cmd_filings,
    "charges": cmd_charges,
    "insolvency": cmd_insolvency,
    "appointments": cmd_appointments,
    "search-officers": cmd_search_officers,
    "search-disqualified": cmd_search_disqualified,
    "registered-office": cmd_registered_office,
}

USAGE = """\
Usage: ch <command> [args...]

Commands:
  search <query>                  Search for companies by name/number
  profile <number>                Get company profile
  officers <number> [current]     List officers (optionally current only)
  pscs <number>                   List persons with significant control
  filings <number> [category]     Get filing history
  charges <number>                Get charges/mortgages
  insolvency <number>             Get insolvency information
  appointments <officer_id>       Get all appointments for an officer
  search-officers <name>          Search for officers by name
  search-disqualified <name>      Search disqualified officers
  registered-office <number>      Get registered office address

API key is read from .env file (COMPANIES_HOUSE_API_KEY=...)"""


def main():
    if len(sys.argv) < 2:
        print(USAGE)
        sys.exit(1)

    command = sys.argv[1]
    args = sys.argv[2:]

    if command in ("help", "--help", "-h"):
        print(USAGE)
        sys.exit(0)

    if command not in COMMANDS:
        print(f"Unknown command: {command}", file=sys.stderr)
        print(USAGE, file=sys.stderr)
        sys.exit(1)

    api_key = load_key()
    COMMANDS[command](api_key, args)


if __name__ == "__main__":
    main()
